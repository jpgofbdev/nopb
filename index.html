<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoPb ‚Äì Plans d‚Äôeau</title>
  <link rel="icon" href="data:,">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    html, body { height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { height:100%; display:grid; grid-template-rows:52px 1fr; }

    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:0 12px; background:#fff; border-bottom:1px solid #e6e6e6;
    }
    .brand { display:flex; gap:10px; align-items:baseline; }
    .title { font-weight:750; font-size:18px; letter-spacing:0.2px; }
    .subtitle { font-size:12px; color:#666; }
    .toplinks a {
      margin-left:6px; text-decoration:none; border:1px solid #ddd;
      border-radius:8px; padding:4px 7px; background:#fff;
    }
    .toplinks a:hover { background:#f6f6f6; }

    #map { width:100%; height:100%; }

    .panel {
      position:absolute; left:12px; top:70px; z-index:1000;
      background:#fff; border:1px solid #cfcfcf; border-radius:10px;
      padding:10px; width:250px; box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .panel button {
      width:100%; padding:8px 10px; border-radius:8px;
      border:1px solid #cfcfcf; background:#fff; cursor:pointer;
      font-weight:600;
    }
    .panel button:hover { background:#f6f6f6; }
    .status { margin-top:8px; font-size:12px; line-height:1.35; color:#333; }

    .afficher {
      position:absolute; right:12px; top:70px; z-index:1000;
      background:#fff; border:1px solid #cfcfcf; border-radius:10px;
      padding:10px; width:170px; box-shadow:0 6px 18px rgba(0,0,0,0.06);
      font-size:13px;
    }

    .searchBox {
      position:absolute; right:12px; bottom:18px; z-index:1000;
      background:#fff; border:1px solid #cfcfcf; border-radius:10px;
      padding:8px; width:260px; box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .searchBox input {
      width:100%; padding:8px; box-sizing:border-box;
      border:1px solid #ddd; border-radius:8px; outline:none;
    }
    .searchBox input:focus { border-color:#b9b9b9; }
    #suggestions {
      margin-top:6px; border:1px solid #eee; border-radius:8px;
      overflow:hidden; display:none; background:#fff; max-height:240px; overflow-y:auto;
    }
    .suggestion { cursor:pointer; padding:8px 10px; font-size:13px; }
    .suggestion:hover { background:#f2f2f2; }

    /* un peu plus compact sur petits √©crans */
    @media (max-width: 520px) {
      .panel { width:210px; }
      .searchBox { width:220px; }
      .afficher { width:160px; }
      .subtitle { display:none; }
    }
  </style>
</head>

<body>
<div id="app">
  <header>
    <div class="brand">
      <div class="title">ü™® NoPb</div>
      <div class="subtitle">Plans d‚Äôeau ‚Ä¢ Parquet client-side</div>
    </div>
    <div class="toplinks">
      <a href="./documentation.html" title="Documentation">üìñ</a>
      <a href="./apropos.html" title="√Ä propos">‚ÑπÔ∏è</a>
    </div>
  </header>

  <div style="position:relative">
    <div id="map"></div>

    <div class="panel">
      <button id="btnLocate">üìç Localisez-moi</button>
      <div class="status" id="status">Initialisation‚Ä¶</div>
    </div>

    <div class="afficher">
      <b>Afficher :</b><br>
      <label><input type="checkbox" id="chkTampon" checked> tampon 100 m</label><br>
      <label><input type="checkbox" id="chkPlan" checked> plans d‚Äôeau</label>
    </div>

    <div class="searchBox">
      <input id="communeInput" placeholder="Commune (BAN)" autocomplete="off">
      <div id="suggestions"></div>
    </div>
  </div>
</div>

<script type="module">
  /********************
   * CONFIG (robuste GitHub Pages)
   ********************/
  const SITE_BASE   = "/nopb";
  const DUCKDB_DIST = `${SITE_BASE}/vendor/duckdb/1.28.0/dist`;

  const PLAN_PARQUET   = `${SITE_BASE}/data/planDeau.parquet`;
  const TAMPON_PARQUET = `${SITE_BASE}/data/planDeau_tampon_100m.parquet`;

  const statusEl = document.getElementById("status");
  const setStatus = (s) => statusEl.textContent = s;

  /********************
   * MAP (Leaflet)
   ********************/
  const map = L.map("map", { zoomControl: false }).setView([46.6, 2.4], 6);

  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom: 19, attribution: "&copy; OpenStreetMap" }).addTo(map);

  const carto = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
    { maxZoom: 20, attribution: "&copy; OSM &copy; CARTO" });

  const esri  = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 19, attribution: "Tiles &copy; Esri" });

  L.control.layers(
    { "OSM (d√©faut)": osm, "CARTO Light": carto, "Esri Satellite": esri },
    {},
    { collapsed: true, position: "bottomleft" }
  ).addTo(map);

  map.createPane("tampon"); map.getPane("tampon").style.zIndex = 410;
  map.createPane("plan");   map.getPane("plan").style.zIndex = 420;

  // Auto-locate au chargement (acc√©l√®re la premi√®re vue)
  setTimeout(() => { try { map.locate({ setView:true, maxZoom:14, enableHighAccuracy:false, timeout:8000 }); } catch {} }, 350);

  document.getElementById("btnLocate").onclick = () =>
    map.locate({ setView:true, maxZoom:16, enableHighAccuracy:true, timeout:12000 });

  map.on("locationfound", (e) => setStatus(`Position trouv√©e (¬±${Math.round(e.accuracy)} m)`));
  map.on("locationerror", () => setStatus("Localisation impossible (autorisation refus√©e ou signal indisponible)."));

  /********************
   * BAN (communes)
   ********************/
  const inp = document.getElementById("communeInput");
  const sug = document.getElementById("suggestions");
  let banTimer = null;

  function clearSug() { sug.innerHTML = ""; sug.style.display = "none"; }

  function showSug(features) {
    sug.innerHTML = "";
    if (!features?.length) return clearSug();
    for (const f of features) {
      const div = document.createElement("div");
      div.className = "suggestion";
      div.textContent = f.properties?.label || "Commune";
      div.onclick = () => {
        clearSug();
        const [lon, lat] = f.geometry.coordinates;
        map.setView([lat, lon], 13);
        setStatus(`Zoom sur : ${div.textContent}`);
      };
      sug.appendChild(div);
    }
    sug.style.display = "block";
  }

  inp.addEventListener("input", () => {
    const q = inp.value.trim();
    if (banTimer) clearTimeout(banTimer);
    if (q.length < 3) return clearSug();
    banTimer = setTimeout(async () => {
      try {
        const r = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&type=municipality&autocomplete=1&limit=8`);
        const j = await r.json();
        showSug(j.features);
      } catch (e) {
        console.warn(e);
        clearSug();
        setStatus("Recherche commune indisponible (BAN).");
      }
    }, 220);
  });
  inp.addEventListener("blur", () => setTimeout(clearSug, 200));

  /********************
   * DUCKDB-WASM (MVP ONLY)
   ********************/
  import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm";

  async function assertOk(url, label) {
    const r = await fetch(url, { method: "GET" });
    if (!r.ok) throw new Error(`${label} introuvable : ${url} (HTTP ${r.status})`);
    return true;
  }

  const MVP_WASM   = `${DUCKDB_DIST}/duckdb-mvp.wasm`;
  const MVP_WORKER = `${DUCKDB_DIST}/duckdb-browser-mvp.worker.js`;

  try {
    setStatus("V√©rification fichiers DuckDB‚Ä¶");
    await assertOk(MVP_WORKER, "Worker");
    await assertOk(MVP_WASM, "WASM");

    setStatus("D√©marrage DuckDB (MVP)‚Ä¶");
    const worker = new Worker(MVP_WORKER); // worker classique (pas module)
    const db = new duckdb.AsyncDuckDB(new duckdb.ConsoleLogger(), worker);
    await db.instantiate(MVP_WASM);
    const conn = await db.connect();

    // IMPORTANT pour extensions en WASM : utiliser des r√©pertoires existants
    setStatus("Pr√©paration environnement‚Ä¶");
    await conn.query("SET home_directory='/'");
    await conn.query("SET extension_directory='/'");

    // Extension spatial
    setStatus("Installation extension spatial‚Ä¶");
    await conn.query("INSTALL spatial;");
    setStatus("Chargement extension spatial‚Ä¶");
    await conn.query("LOAD spatial;");

    // Lecture parquet -> GeoJSON via spatial (ST_GeomFromWKB + ST_AsGeoJSON)
    async function parquetToLayer(url, pane, style) {
      const ab = await (await fetch(url)).arrayBuffer();
      const buf = new Uint8Array(ab);
      await db.registerFileBuffer(url, buf);

      const r = await conn.query(`
        SELECT ST_AsGeoJSON(ST_GeomFromWKB(geometry)) AS g
        FROM read_parquet('${url}')
        WHERE geometry IS NOT NULL
      `);

      const feats = [];
      const col = r.getChild("g");
      for (let i = 0; i < r.numRows; i++) {
        const gj = col.get(i);
        if (!gj) continue;
        feats.push({ type: "Feature", properties: {}, geometry: JSON.parse(gj) });
      }

      return L.geoJSON({ type:"FeatureCollection", features: feats }, {
        pane,
        style: () => style
      }).addTo(map);
    }

    setStatus("Chargement : tampon 100 m‚Ä¶");
    const tampon = await parquetToLayer(TAMPON_PARQUET, "tampon", {
      color: "#1f6feb", weight: 1, fillColor: "#1f6feb", fillOpacity: 0.30, opacity: 0.85
    });

    setStatus("Chargement : plans d‚Äôeau‚Ä¶");
    const plan = await parquetToLayer(PLAN_PARQUET, "plan", {
      color: "#1f6feb", weight: 1.4, fillColor: "#1f6feb", fillOpacity: 0.55, opacity: 0.95
    });

    document.getElementById("chkTampon").onchange = (e) =>
      e.target.checked ? map.addLayer(tampon) : map.removeLayer(tampon);

    document.getElementById("chkPlan").onchange = (e) =>
      e.target.checked ? map.addLayer(plan) : map.removeLayer(plan);

    // Fit bounds
    const b = tampon.getBounds();
    if (b?.isValid()) b.extend(plan.getBounds());
    if (b?.isValid()) map.fitBounds(b, { padding: [20, 20] });

    setStatus("OK ‚Äì Parquet charg√©.");

    // Nettoyage √† la fermeture
    window.addEventListener("beforeunload", async () => {
      try { await conn.close(); } catch {}
      try { await db.terminate(); } catch {}
      try { worker.terminate(); } catch {}
    });

  } catch (err) {
    console.error(err);
    setStatus("Erreur DuckDB (voir console).");
  }
</script>

</body>
</html>
