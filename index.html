<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoPb ‚Äì Plans d‚Äôeau</title>

  <link rel="icon" href="data:,">

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          crossorigin=""></script>

  <style>
    html, body { height:100%; margin:0; font-family:system-ui, sans-serif; }
    #app { height:100%; display:grid; grid-template-rows:52px 1fr; }
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:0 12px; background:#fff; border-bottom:1px solid #e6e6e6;
    }
    .brand { display:flex; gap:10px; align-items:baseline; }
    .title { font-weight:700; font-size:18px; }
    .subtitle { font-size:12px; color:#666; }
    .toplinks a {
      margin-left:6px; text-decoration:none; border:1px solid #ddd;
      border-radius:6px; padding:4px 6px;
    }
    #map { width:100%; height:100%; }

    .panel {
      position:absolute; left:12px; top:70px; z-index:1000;
      background:#fff; border:1px solid #ccc; border-radius:8px;
      padding:10px; width:220px;
    }
    .panel button {
      width:100%; padding:6px; border-radius:6px;
      border:1px solid #ccc; cursor:pointer;
    }
    .status { margin-top:6px; font-size:12px; }

    .afficher {
      position:absolute; right:12px; top:70px; z-index:1000;
      background:#fff; border:1px solid #ccc; border-radius:8px;
      padding:10px; width:150px; font-size:13px;
    }

    .searchBox {
      position:absolute; right:12px; bottom:18px; z-index:1000;
      background:#fff; border:1px solid #ccc; border-radius:8px;
      padding:8px; width:220px;
    }
    .searchBox input { width:100%; padding:6px; }
    #suggestions { margin-top:6px; }
    .suggestion { cursor:pointer; padding:4px; }
    .suggestion:hover { background:#eee; }
  </style>
</head>

<body>
<div id="app">
<header>
  <div class="brand">
    <div class="title">üß™ NoPb</div>
    <div class="subtitle">Parquet client-side</div>
  </div>
  <div class="toplinks">
    <a href="./documentation.html">üìñ</a>
    <a href="./apropos.html">‚ÑπÔ∏è</a>
  </div>
</header>

<div style="position:relative">
  <div id="map"></div>

  <div class="panel">
    <button id="btnLocate">üìç Localisez-moi</button>
    <div class="status" id="status">Chargement‚Ä¶</div>
  </div>

  <div class="afficher">
    <b>Afficher :</b><br>
    <label><input type="checkbox" id="chkTampon" checked> tampon 100 m</label><br>
    <label><input type="checkbox" id="chkPlan" checked> plans d‚Äôeau</label>
  </div>

  <div class="searchBox">
    <input id="communeInput" placeholder="Commune">
    <div id="suggestions"></div>
  </div>
</div>
</div>

<script type="module">
/* ================= CONFIG ================= */
const DUCKDB_DIST = "/nopb/vendor/duckdb/1.28.0/dist";
const PLAN_PARQUET = "/nopb//data/planDeau.parquet";
const TAMPON_PARQUET = "/nopb//data/planDeau_tampon_100m.parquet";

/* ================= MAP ================= */
const map = L.map("map", { zoomControl:false }).setView([46.6, 2.4], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom:19 }).addTo(map);

map.createPane("tampon"); map.getPane("tampon").style.zIndex = 410;
map.createPane("plan");   map.getPane("plan").style.zIndex = 420;

map.locate({ setView:true, maxZoom:14 });

document.getElementById("btnLocate").onclick = () =>
  map.locate({ setView:true, maxZoom:16 });

/* ================= BAN ================= */
const box = document.getElementById("suggestions");
document.getElementById("communeInput").oninput = async e => {
  if (e.target.value.length < 3) return box.innerHTML="";
  const r = await fetch(
    `https://api-adresse.data.gouv.fr/search/?q=${e.target.value}&type=municipality`
  );
  const j = await r.json();
  box.innerHTML = "";
  j.features.forEach(f => {
    const d = document.createElement("div");
    d.className = "suggestion";
    d.textContent = f.properties.label;
    d.onclick = () => {
      map.setView([f.geometry.coordinates[1], f.geometry.coordinates[0]], 13);
      box.innerHTML = "";
    };
    box.appendChild(d);
  });
};

/* ================= DUCKDB ================= */
import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm";

const bundles = {
  mvp: {
    mainModule: `${DUCKDB_DIST}/duckdb-mvp.wasm`,
    mainWorker: `${DUCKDB_DIST}/duckdb-browser-mvp.worker.js`
  },
  eh: {
    mainModule: `${DUCKDB_DIST}/duckdb-eh.wasm`,
    mainWorker: `${DUCKDB_DIST}/duckdb-browser-eh.worker.js`
  }
};

const bundle = await duckdb.selectBundle(bundles);
const worker = new Worker(bundle.mainWorker, { type:"module" });
const db = new duckdb.AsyncDuckDB(new duckdb.ConsoleLogger(), worker);
await db.instantiate(bundle.mainModule);
const conn = await db.connect();

await conn.query("SET home_directory='/'");
await conn.query("SET extension_directory='/'");
await conn.query("INSTALL spatial;");
await conn.query("LOAD spatial;");



  

async function loadParquet(url, pane, style) {
  const buf = new Uint8Array(await (await fetch(url)).arrayBuffer());
  await db.registerFileBuffer(url, buf);
  const r = await conn.query(`
    SELECT ST_AsGeoJSON(ST_GeomFromWKB(geometry)) g
    FROM read_parquet('${url}')
  `);
  const feats = [];
  const col = r.getChild("g");
  for (let i=0;i<r.numRows;i++)
    feats.push({ type:"Feature", geometry:JSON.parse(col.get(i)), properties:{} });
  return L.geoJSON({ type:"FeatureCollection", features:feats },
    { pane, style }).addTo(map);
}

const tampon = await loadParquet(TAMPON_PARQUET, "tampon",
  { color:"#1f6feb", fillOpacity:0.3 });
const plan = await loadParquet(PLAN_PARQUET, "plan",
  { color:"#1f6feb", fillOpacity:0.55 });

document.getElementById("chkTampon").onchange = e =>
  e.target.checked ? map.addLayer(tampon) : map.removeLayer(tampon);
document.getElementById("chkPlan").onchange = e =>
  e.target.checked ? map.addLayer(plan) : map.removeLayer(plan);

map.fitBounds(tampon.getBounds());
document.getElementById("status").textContent = "OK ‚Äì Parquet charg√©";
</script>
</body>
</html>

